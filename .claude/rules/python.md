---
paths: ['src/**/*.py', 'pyproject.toml']
---

# Python è¨­è¨ˆè¦ç´„

yadon-agents ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® Python ã‚³ãƒ¼ãƒ‰è¨­è¨ˆã«é–¢ã™ã‚‹åˆ¤æ–­ã¨æŒ‡é‡ã‚’ã¾ã¨ã‚ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€‚

## commands.py â€” CLIã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰å®Ÿè£…

`commands.py` ã¯å…¨CLIã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ï¼ˆ`yadon start`, `stop`, `status`, `restart`, `say`ï¼‰ã¨å†…éƒ¨ç”¨ã‚³ãƒãƒ³ãƒ‰ï¼ˆ`_send`, `_status`, `_restart`, `_say`ï¼‰ã‚’ Pythonãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã—ãŸã‚‚ã®ã€‚

**è¨­è¨ˆåˆ¤æ–­ï¼š**
- **ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆå»ƒæ­¢** â€” æ—§ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯ `scripts/send_task.sh`, `check_status.sh`, `restart_daemons.sh`, `pet_say.sh` ãªã©è¤‡æ•°ã®ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ç®¡ç†ã—ã¦ã„ãŸãŒã€Pythonãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã™ã‚‹ã“ã¨ã§ï¼š
  - ğŸ’ª **ã‚³ãƒ¼ãƒ‰ä¸€å…ƒç®¡ç†** â€” CLI ãƒ­ã‚¸ãƒƒã‚¯å…¨ä½“ã‚’ Python ã§çµ±ä¸€ç®¡ç†
  - ğŸ“¦ **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–** â€” `pyproject.toml` ã§å®šç¾©ã—ãŸ `console_scripts` ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆçµŒç”±ã§é…å¸ƒãƒ»å®Ÿè¡Œå¯èƒ½
  - ğŸ”§ **ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§** â€” Python unit test ã§ã‚³ãƒãƒ³ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ†ã‚¹ãƒˆå¯èƒ½
  - ğŸš« **ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¾å­˜å»ƒæ­¢** â€” Unix/Linux ç’°å¢ƒç‰¹æœ‰ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆç®¡ç†ãŒä¸è¦
- **å†…éƒ¨ç”¨ã‚³ãƒãƒ³ãƒ‰å‰ç½®è©** â€” `yadon _send` ãªã© `_` å‰ç½®ã‚’ä½¿ç”¨ã—ã¦ã€å†…éƒ¨ç”¨ã¨å…¬é–‹ç”¨ã‚’è¦–è¦šçš„ã«åˆ†é›¢
- **ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ®‹å­˜ãªã—** â€” `start.sh`, `stop.sh` ã¯ `uv run yadon` ã‚„ç›´æ¥ `yadon` ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã«å®Œå…¨ç½®æ›

**ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ:**
- `cli.py` â€” ãƒ¡ã‚¤ãƒ³ã®CLI ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆï¼ˆ`@main.command()` ã§å„ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ç™»éŒ²ï¼‰
- `commands.py` â€” ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰å®Ÿè£…é–¢æ•°ï¼ˆ`cmd_start()`, `cmd_stop()`, `send_task()` Python APIç­‰ï¼‰

## Port & Adapterï¼ˆDIï¼‰

`domain/ports/` ã«æŠ½è±¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã€ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿æ³¨å…¥ã§å…·ä½“å®Ÿè£…ã‚’å·®ã—æ›¿ãˆå¯èƒ½ã«ã™ã‚‹ã€‚

- `AgentPort` â€” ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å…¬é–‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã€‚`BaseAgent` ãŒå®Ÿè£…
- `LLMRunnerPort` â€” LLM CLIå®Ÿè¡Œã®æŠ½è±¡ã€‚`SubprocessClaudeRunner` ãŒå®Ÿè£…
- `ClaudeRunnerPort` â€” å¾Œæ–¹äº’æ›ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼ˆ`LLMRunnerPort` ã¸ã®å‚ç…§ï¼‰

`YadonWorker` / `YadoranManager` ã¯ `claude_runner: ClaudeRunnerPort | None = None` ã‚’å—ã‘å–ã‚Šã€æœªæŒ‡å®šæ™‚ã¯ `SubprocessClaudeRunner()` ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”Ÿæˆã™ã‚‹ã€‚ãƒ†ã‚¹ãƒˆæ™‚ã«ã¯ãƒ¢ãƒƒã‚¯ã‚’æ³¨å…¥å¯èƒ½ã€‚

## BaseAgent + on_bubble callback ã¨ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†

`BaseAgent(AgentPort)` ã® `on_bubble: BubbleCallback | None` ã§å¹ãå‡ºã—é€šçŸ¥ã‚’æŠ½è±¡åŒ–ã€‚
`AgentThread` ãŒ `on_bubble` ã‚’ pyqtSignal ã«æ¥ç¶šã—ã€GUIå±¤ã¨é€£æºã™ã‚‹ã€‚

**ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ã®è¨­è¨ˆåˆ¤æ–­ï¼š**
- `serve_forever()` ãŒ try-finally ã§ä¸€å…ƒç®¡ç†ã—ã€ã©ã®çµŒè·¯ï¼ˆæ­£å¸¸çµ‚äº†ãƒ»ã‚¨ãƒ©ãƒ¼ãƒ»stopå‘¼ã³å‡ºã—ï¼‰ã§ã‚‚ç¢ºå®Ÿã«ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾
  - **å¤–å´ try ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ106-131è¡Œï¼‰**: ã‚µãƒ¼ãƒãƒ¼ã‚½ã‚±ãƒƒãƒˆä½œæˆï¼ˆ`proto.create_server_socket()`ï¼‰â†’ `running = True` â†’ ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ï¼ˆ`while self.running`ï¼‰
    - **å†…å´ try-exceptï¼ˆ113-131è¡Œï¼‰**: ã‚½ã‚±ãƒƒãƒˆå—ã‘å…¥ã‚Œï¼†æ¥ç¶šå‡¦ç†ã€‚ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä¾‹å¤–ï¼ˆ`socket.timeout`ï¼‰ã¯è¨±å®¹ã—ã¦ç¶™ç¶šã€ãã®ä»–ã® OSError ã¯ break ã—ã¦å¤–å´ finally ã¸
    - **æ¥ç¶šå‡¦ç†ï¼ˆ115-126è¡Œï¼‰**: `server_sock.accept()` ã§ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³å—ã‘å…¥ã‚Œ â†’ ã‚¹ãƒ¬ãƒƒãƒ‰ç”Ÿæˆ â†’ `thread.join()` ã§è©²æ¥ç¶šå‡¦ç†çµ‚äº†ã¾ã§å¾…æ©Ÿï¼ˆãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰
  - **finally ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ132-135è¡Œï¼‰**: ã‚µãƒ¼ãƒãƒ¼ã‚½ã‚±ãƒƒãƒˆã®ã‚¯ãƒ­ãƒ¼ã‚ºï¼ˆ`self.server_sock.close()`ï¼‰ã¨ ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ï¼ˆ`proto.cleanup_socket()`ï¼‰ã‚’ä¸€æœ¬åŒ–
  - **åŠ¹æœ**: ã‚­ãƒ¼ãƒ—ã‚¢ãƒ©ã‚¤ãƒ–ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚¿ã‚„ã‚½ã‚±ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒç¢ºå®Ÿã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã•ã‚Œã€ãƒªã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã®ç«¶åˆã‚’é˜²æ­¢
- `serve_forever()` å†…ã® while ãƒ«ãƒ¼ãƒ—ã§ `SOCKET_ACCEPT_TIMEOUT` ã‚’çŸ­ãï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1ç§’ï¼‰è¨­å®šã—ã€`running` ãƒ•ãƒ©ã‚°ã®å¤‰æ›´ã‚’å³åº§ã«æ¤œçŸ¥å¯èƒ½ã«
- `stop()` ãƒ¡ã‚½ãƒƒãƒ‰ã¯ `self.running = False` ã‚’è¨­å®šã™ã‚‹ã®ã¿ã§è²¬å‹™ã‚’æ˜ç¢ºåŒ–ã€‚ã‚½ã‚±ãƒƒãƒˆã‚¯ãƒ­ãƒ¼ã‚ºãƒ»ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã¯ finally ãƒ–ãƒ­ãƒƒã‚¯ã§ä¸€æœ¬åŒ–
- ã“ã®åˆ†é›¢ã«ã‚ˆã‚Šã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå´ã‹ã‚‰ stop å‘¼ã³å‡ºã—ã—ã¦ã‚‚ã€ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—çµ‚äº†æ™‚ã«ã¯å¿…ãš finally ãƒ–ãƒ­ãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã€ãƒªã‚½ãƒ¼ã‚¹ãŒç¢ºå®Ÿã«è§£æ”¾ã•ã‚Œã‚‹
  - **ã‚¹ãƒ¬ãƒƒãƒ‰å®‰å…¨æ€§**: `thread.join()` ãŒãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°å¾…æ©Ÿã™ã‚‹ãŸã‚ã€handle_task() ä¸­ã®å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ³ãƒ‰ãƒ«ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šç­‰ï¼‰ãŒç¢ºå®Ÿã«å®Œäº†ã—ã¦ã‹ã‚‰æ¬¡ã®æ¥ç¶šã‚’å‡¦ç†
  - **stop ãƒ•ãƒ­ãƒ¼**: `stop()` å‘¼ã³å‡ºã— â†’ `running = False` â†’ while ãƒ«ãƒ¼ãƒ—è„±å‡º â†’ finally å®Ÿè¡Œ â†’ ãƒªã‚½ãƒ¼ã‚¹ç¢ºå®Ÿè§£æ”¾

## ãƒ†ã‚¹ãƒˆã®æ³¨æ„ç‚¹

- **FakeClaudeRunner**: å„ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`test_manager.py`ã€`test_worker.py`ã€`test_claude_runner.py`ï¼‰å†…ã§`ClaudeRunnerPort`ãƒ¢ãƒƒã‚¯ã‚’ç‹¬ç«‹ã«å®šç¾©ã€‚å…±æœ‰ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã¯ä½¿ç”¨ã›ãšã€ãƒ†ã‚¹ãƒˆç‹¬ç«‹æ€§ã‚’ç¢ºä¿
- **setup_method**: ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã®å„ãƒ†ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè¡Œå‰ã«`setup_method`ã§ theme cache ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆ`from yadon_agents.config.ui import PIXEL_DATA_CACHE; PIXEL_DATA_CACHE.clear()`ï¼‰

## uv ä¾å­˜ç®¡ç†

`pip install -e .` ã®ä»£ã‚ã‚Šã« `uv` ã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä¾å­˜ã‚’ç®¡ç†ã™ã‚‹ã€‚
`pyproject.toml` ã«å®šç¾©ã•ã‚ŒãŸä¾å­˜ãŒè‡ªå‹•è§£æ±ºã•ã‚Œã€`uv run` ã§å®Ÿè¡Œæ™‚ã«é©ç”¨ã•ã‚Œã‚‹ã€‚
ä»¥å‰ã¯ start.sh ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã—ãŸãŒã€ç¾åœ¨ã¯ `uv run yadon` ã¾ãŸã¯ç›´æ¥ `yadon` ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™ã€‚

**ä¾å­˜ç®¡ç†æ–¹é‡:**
- **æœ¬ä½“ä¾å­˜** â€” `[project] dependencies` ã§ç®¡ç†ï¼ˆPyQt6ç­‰ï¼‰
- **é–‹ç™ºä¾å­˜** â€” `[dependency-groups] dev` ã§ç®¡ç†ï¼ˆpytestç­‰ï¼‰ã€‚`optional-dependencies` ã¯ä½¿ç”¨ã—ãªã„
- å…¨ã¦ã®ä¾å­˜ã¯ `[dependency-groups] dev` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ä¸€å…ƒç®¡ç†

## PIDç®¡ç†ã®æ’¤å»

æ—§ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã¯è¤‡æ•°ã®ãƒ‡ãƒ¼ãƒ¢ãƒ³ãƒ—ãƒ­ã‚»ã‚¹ã‚’ PID ãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†ã—ã¦ã„ãŸã€‚

**ç¾åœ¨ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆGUIãƒ‡ãƒ¼ãƒ¢ãƒ³ + CLIåˆ†é›¢ï¼‰:**
- âœ… **PID ãƒ•ã‚¡ã‚¤ãƒ«å»ƒæ­¢** â€” ãƒ—ãƒ­ã‚»ã‚¹ã¯ `pkill -f` ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã§åœæ­¢ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹è¿½è·¡ä¸è¦
- âœ… **log_dir()ã¸ã®ä¸€æœ¬åŒ–** â€” `log_dir()` ã¯ **ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã¿**ç”Ÿæˆã€‚PIDè¿½è·¡ãªã—
- âœ… **yadon stop ã®å®Ÿè£…** â€” `pkill -f "yadon_agents.gui_daemon"` ã¨ `pkill -f "yadon_agents.cli start"` ã§2ã¤ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢

`infra/process.py` ã® `log_dir()`:
```python
def log_dir() -> Path:
    """ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºä¿ï¼ˆPIDç®¡ç†ãªã—ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç”Ÿæˆã®ã¿ï¼‰"""
    base = Path.home() / ".yadon-agents" / "logs"
    base.mkdir(parents=True, exist_ok=True)
    return base
```
